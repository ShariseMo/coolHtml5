<div class="top">
	<h2>以下是该机器的【屏保设置】</h2>
</div>
<div class="content_box">
	<div class="info_box">
	<form id="adForm">
		<p>滚屏公告：<input type="text" name="notice" placeholder="请输入滚屏公告">&nbsp;&nbsp;显示公告：<input type="checkbox" name="showNotice" id="showNotice"></p>
		<p>
			屏保模板：
			<select name="adTemplate" id="adTemplate" style="width:150px" onchange="changeTem(this)">
				<option  value="1">产品为主的模板</option>
				<option  value="2">视频为主的模板</option>
				<option  value="3">海报为主的模板</option>
				<option  value="4">天气为主的模板</option>
			</select>
			&nbsp;<a href="/adv_template_poster.psd">850x505px PSD海报模板下载</a>&nbsp;
			&nbsp;<a href="/adv_template_other.psd">720x325px PSD海报模板下载</a>
		</p>
	</form>
		<button class="btn_save" onclick="ad_save()">保存设置</button>
	</div>

	<!-- 展示部分 -->
	<div class="showBox">
		<div class="showContent">
			<div class="left_box">
				<div class="leftImg">
					<img src="./image/client_background/shenqi_tigan.png">
					<img src="./image/client_background/shenqi_camera.png">
				</div>
				<div class="lb_box">
					<!-- <div class="listBox">
						<div class="mask">	
							<div class="topBar1 hidden">
								<p>
									<input type="text" name="keyWord" placeholder="输入产品关键字">
									<a class="search_btn" onclick="productList1(1)"><img src="./image/client_background/search_btn.png" heigth="26px"></a>
									<a class="del_btn" onclick="delAllPro()"><img src="./image/client_background/material_delete.png" height="25px"></a>
									<a class="addShow_btn" data-toggle="modal" data-target="#lampModal" onclick="loadProductData()">添加展示内容</a>
								</p>
							</div>
							<div class="productList"></div>
						</div>
					</div> -->
				</div>
			</div>

			<div class="right_box">
				<div class="rt_box">
					<!-- <div class="video">
						<video controls src=""></video>
						<div class="topBar hidden">
							<a href="#" class="changeVideo btn_change" data-toggle="modal" data-target="#videoModal" onclick="loadMaterial(2)">更换展示内容</a>
						</div>
					</div> -->
				</div>
				<div class="rb_box">
					<!-- <div class="sence">
						
						<div id="carousel-example-generic" class="carousel slide" data-ride="carousel">
							   <div class="carousel-inner" role="listbox"></div>
							  <a class="left carousel-control" href="#carousel-example-generic" role="button" data-slide="prev"></a>
							  <a class="right carousel-control" href="#carousel-example-generic" role="button" data-slide="next"></a>
						</div>
						<div class="topBar hidden">
							<a href="#" class="changePic btn_change" data-toggle="modal" data-target="#senceModal" onclick="loadMaterial(3)">更换展示内容</a>
						</div>
					</div> -->
				</div>
			</div>
		</div>
	</div>
</div> 



<script type="text/javascript">

	var machineId = getUrlParam('machineId');
	var adId;
	var adTemplate;  //模板类型(以产品为主，视频为主，海报为主，天气为主)
	var pageNum = 1;   //页面中的页码
	var pageNum2 =1;   //弹出框里面的页码
	var totalPages;    //总页数

	window.onload=loadData();

	// 切换模板时换位置
	function changePosition(data){
		var temNum = data['ad']['adTemplate'];
		var lampText = '<div class="listBox"><div class="mask"><div class="topBar1 hidden"><p><input type="text" name="keyWord" placeholder="关键字"><a class="search_btn" onclick="productList1(1)"><img src="./image/client_background/search_btn.png" heigth="26px"></a><a class="del_btn" onclick="delAllPro()"><img src="./image/client_background/material_delete.png" height="25px"></a><a class="addShow_btn" data-toggle="modal" data-target="#lampModal" onclick="loadProductData()">添加展示内容</a></p></div><div class="productList"></div></div></div>';
		var videoText = '<div class="video"><video controls src=""></video><div class="topBar hidden"><a href="#" class="changeVideo btn_change" data-toggle="modal" data-target="#videoModal" onclick="loadMaterial(2)">更换展示内容</a></div></div>';
		var posterText = '<div class="sence"><div id="carousel-example-generic" class="carousel slide" data-ride="carousel"><div class="carousel-inner" role="listbox"></div><a class="left carousel-control" href="#carousel-example-generic" role="button" data-slide="prev"></a><a class="right carousel-control" href="#carousel-example-generic" role="button" data-slide="next"></a></div><div class="topBar hidden"><a href="#" class="changePic btn_change" data-toggle="modal" data-target="#senceModal" onclick="loadMaterial(3)">更换展示内容</a></div></div>';
		switch(temNum){
			case 1 : {
				$('.lb_box').append(lampText);
				$('.rt_box').append(videoText);
				$('.rb_box').append(posterText);
				break;
			}
			case 2 : {
				$('.lb_box').append(videoText);
				$('.rt_box').append(lampText);
				$('.rb_box').append(posterText);
				break;
			}
			case 3 : {
				$('.lb_box').append(posterText);
				$('.rt_box').append(videoText);
				$('.rb_box').append(lampText);
				break;
			}
			case 4 : {
				$('.lb_box').append(posterText);
				$('.rt_box').append(videoText);
				$('.rb_box').append(lampText);
			}
		}
	}

	// 页面内容
	function pageContent(data){
		for(var i = 0 ;i<data['materials'].length;i++){
			if(data['materials'][i]['materialType']==2){
				$('.video video').attr('src',data['materials'][i]['materialBody']);
			}
			if(data['materials'][i]['materialType']==3){
				$('.sence .carousel-inner').append("<div class='item'><img src='"+data['materials'][i]['materialBody']+"'></div>");
				$('.carousel-inner .item').eq(1).addClass('active');
			}					
		}	
		overOut(".listBox",".listBox .topBar1");		
		overOut(".video",".video .topBar");
		overOut(".sence",".sence .topBar");
		productList(1);
		moreGoods();
	}

	// 页面初始加载数据
	function loadData(){
		$.ajax({
			url:"/machine_ad/"+machineId,
			method:"get",
			success:function(result){
				var data = result['data'];
				console.log(data);
				// info
				adId = data['ad']['adId'];
				adTemplate = data['ad']['adTemplate'];
				$('input[name=notice]').val(data['ad']['notice']);
				if(data['ad']['showNotice']==0){
					document.getElementById('showNotice').checked = false;
				}else document.getElementById('showNotice').checked = true;
				$('#adTemplate').val(data['ad']['adTemplate']);
				// showBox
				changePosition(data);
				pageContent(data);
				
			},
		});	
	}	

	// 屏保模板改变
	function changeTem(obj){
		$('.lb_box').html('');
		$('.rt_box').html('');
		$('.rb_box').html('');		
		var newTem = $(obj).val();
		// console.log(newTem);
		$.ajax({
			url:"machine_ad/"+machineId+"/"+newTem,
			method:"get",
			success:function(result){
				var data = result['data'];
				adId = data['ad']['adId'];
				adTemplate = data['ad']['adTemplate'];
				changePosition(data);
				pageContent(data);
			}
		});
	}

	// 保存屏保设置
	function ad_save(){
		if($('#showNotice').is(':checked')){
			$('#showNotice').val(1);
		}else{
			$('#showNotice').val(0);
		}
		var data = $('#adForm').serialize();
		console.log(data);
		$.ajax({
			url:"/machine_ad/"+adId,
			method:"post",
			data:data,
			success:function(){
				alert("修改成功！");
			}
		});
	}

	// 加载产品列表
	function productList(pageNum){
		var proKey = $('input[name=keyWord]').val();
		console.log(adTemplate);
		$.ajax({
			url:"/machine_ad_product/"+machineId+"/"+adTemplate,
			method:"get",
			data:{
				pageNumber:pageNum,
				pageSize:16,
				keyword:proKey
			},
			success:function(result){
				console.log(result);
				var data = result['data'];
				for(var i = 0;i<data['list'].length;i++){
					$('.productList').append("<div class='item'><img src='"+data['list'][i]['imgpath']+"'><p>"+data['list'][i]['productnum']+"</p><span class='del_icon' onclick='delOne(this)' data-mid='"+data['list'][i]['materialId']+"' data-pid='"+data['list'][i]['productid']+"'>X</span></div>");
				}
			}
		});
	}

	// 查询
	function productList1(pageNum){
		var proKey = $('input[name=keyWord]').val();
		$('.productList').html('');
		$.ajax({
			url:"/machine_ad_product/"+machineId+"/1",
			method:"get",
			data:{
				pageNumber:pageNum,
				pageSize:16,
				keyword:proKey
			},
			success:function(result){
				console.log(result);
				var data = result['data'];
				for(var i = 0;i<data['list'].length;i++){
					$('.productList').append("<div class='item'><img src='"+data['list'][i]['imgpath']+"'><p>"+data['list'][i]['productnum']+"</p><span class='del_icon' onclick='delOne(this)' data-mid='"+data['list'][i]['materialId']+"' data-pid='"+data['list'][i]['productid']+"'>X</span></div>");
				}
			}
		});
	}

	// 当鼠标滚动时加载更多产品
	function moreGoods(){  //flag=1：页面中的分页，flag= 2 ：弹框中的分页
		var nScrollHight = 0; //滚动距离总长(注意不是滚动条的长度)
	    var nScrollTop = 0;   //滚动到的当前位置
	    var nDivHight = $(".listBox").height();
		 $(".listBox").scroll(function(){
	          nScrollHight = $(this)[0].scrollHeight;
	          nScrollTop = $(this)[0].scrollTop;
	          if(nScrollTop + nDivHight >= nScrollHight)
		          	productList(pageNum);
		          // $('.mask').attr('height',nDivHight);
	         	// console.log(pageNum);
	         	pageNum += 1;    	
         });
	}
	

	// 页面中删除单个产品
	function delOne(obj){
		var materialId = $(obj).attr('data-mid');
		var productId = $(obj).attr('data-pid');
		// console.log(materialId+","+productId);
		$.ajax({
			url:"/remove_product/"+materialId,
			method:"post",
			data:{
				productId:productId
			},
			success:function(){
				var parent = $(obj).parent();
				$(parent).remove();
				console.log("删除单个产品");
			}
		});
	}

	// 页面中删除全部产品
	function delAllPro(){
		var aa = confirm("确定要删除吗？");
		if(aa){
			$.ajax({
				url:"/machine_ad_product/"+adId,
				method:"delete",
				success:function(){
					$('.productList').html('没有选中的产品！').css({
						'font-size':'20px',
						'padding':'105px'
					});
					console.log("全部删除了");
				}
			});
		}	
	}

	
</script>

<!-- lampModal -->		
<div class="modal fade" id="lampModal" tabindex="-1" role="dialog" aria-labelledby="lampModalLabel">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">X</span>
				</button>
				<h4 class="modal-title" id="lampModalLabel">显示产品条件筛选</h4>
				
			</div>
			<div class="modal-body">
				<div class="proCondition">
					<p>
						风格：<select name="styles" id="styles" onchange="proList2(1)"><option value="">全部</option></select>&nbsp;&nbsp;
						类型：<select name="types" id="types" onchange="proList2(1)"><option value="">全部</option></select>
					</p>
					<p>
						空间：<select name="spaces" id="spaces" onchange="proList2(1)"><option value="">全部</option></select>&nbsp;&nbsp;
						材质：<select name="pmade" id="pmade" onchange="proList2(1)"><option value="">全部</option></select>
					</p>
					<p>
						价格：<select name="price" id="price" onchange="proList2(1)">
								  <option value="">全部</option>
								  <option value="0-499">0-499</option>
								  <option value="500-1999">500-1999</option>
								  <option value="2000-4999">2000-4999</option>
								  <option value="5000-9999">5000-9999</option>
								  <option value="10000-19999">10000-19999</option>
								  <option value="20000以上">20000以上</option>
							  </select>&nbsp;&nbsp;
						自定义价格段:<input type="text" name="range1">--<input type="text" name="range2">
					</p>
					<p>
						品牌：<select name="brands" id="brands" onchange="proList2()"><option value="">全部</option></select>&nbsp;&nbsp;
						关键字：<input type="text" name="keyword" id="keyword"> <button class="btn_search" onclick="proList2()">查询</button>
					</p>
				</div>
				<div class="" id="proTable_box">
				<form id="proForm">
					<table class="table_box">
						<tr>
							<th width="100px">编号</th>
							<th width="73px">产品图</th>
							<th width="180px">名称</th>
							<th width="80px">品牌</th>
							<th width="70px">价格</th>
							<th width="45px">选择</th>
						</tr>
					</table>
					<div id="productList2_box">	
						<table class="table_box" id="productList2">
							<tbody></tbody>
						</table>
					</div>
					<div style="text-align:center;">
						<a style="display:inline-block;width:60px;height:20px;border:1px solid #ccc;" onclick="pre_next(-1)">上一页</a>
						<a style="display:inline-block;width:60px;height:20px;border:1px solid #ccc;" onclick="pre_next(1)">下一页</a>
					</div>
				</form>
				</div>
			</div>
			<div class="modal-footer">
				<p>
					=====符合条件的商品共<span id="totalCount"></span>个=====
					<input type="checkbox" name="" id="selAllPro">选择当前条件下的所有商品
				</p>
				<button type="button" class="btn_ok" onclick="pro_getSelect()">确定</button>
				<button type="button" class="btn_cancel" data-dismiss="modal">取消</button>
			</div>
		</div>
	</div>
</div>
<!-- videoModal -->		
<div class="modal fade" id="videoModal" tabindex="-1" role="dialog" aria-labelledby="videoModalLabel">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">X</span>
				</button>
				<h4 class="modal-title" id="videoModalLabel">素材选择</h4>
				
			</div>
			<form id="videoListForm"><div class="modal-body videoList"></div></form>
			<div class="uploadProgress hidden">正在上传中...</div>
			<div class="modal-footer">
				<div id="container" style="display:inline-block">
					<input type="file" class="hidden" id="uploadVideo"><!--onchange="loadFile(2)"-->
					<label for="uploadVideo" class="btn_ok">上传素材</label>
				</div>
				<button type="button" class="btn_ok" onclick="okMaterial(2)">确定</button>
				<button type="button" class="btn_cancel" data-dismiss="modal">取消</button>
				<p class="upload_tips">上传视频最大为600Mb，建议分辨率不低于560p。</p>
			</div>
		</div>
	</div>
</div>
<!-- senceModal -->		
<div class="modal fade" id="senceModal" tabindex="-1" role="dialog" aria-labelledby="senceModalLabel">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">X</span>
				</button>
				<h4 class="modal-title" id="senceModalLabel">素材选择</h4>
				
			</div>
			<form id="senceListForm"><div class="modal-body senceList"></div></form>
			<div class="modal-footer">
				<!-- 上传图片 -->
				<form method="post" action="/materials" id="imageForm" name="imageForm" enctype="multipart/form-data" style="display:inline-block;">	
					<input type="file" class="hidden" name="uploadImage" id="uploadImage" onchange="clickUpload()">
					<label for="uploadImage" class="btn_ok">上传素材</label>
					<input type="button" name="" class="hidden" id="uploadSubmit" onclick="loadFile(3)">
				</form>
				<button type="button" class="btn_ok" onclick="okMaterial(3)">确定</button>
				<button type="button" class="btn_cancel" data-dismiss="modal">取消</button>
				<p class="upload_tips">上传海报尺寸建议为720px*325px，最多一次上传6个。</p>
			</div>
		</div>
	</div>
</div>


<script type="text/javascript">
  
  // 更换展示内容(弹框加载数据)
	function loadMaterial(materialType){
		// console.log(materialType);
		$.ajax({
			url:"/materials",
			method:"get",
			data:{
				materialType:materialType,
				adTemplate:adTemplate,
				// position:"",
			},
			success:function(result){
				var data = result['data'];
				$('.videoList').html("");
				$('.senceList').html("");
				console.log(result);
				for(var i = 0;i<data.length;i++){
					if(materialType==2){
						if(data[i]['isSelect']=='1'){
							$('.videoList').append("<div class='videoItem' onclick='isSelected(this)'><video controls src='"+data[i]['materialBody']+"' width='238px' height='125px'></video><span class='del_icon2 hidden' onclick='delItem(this)' data-option="+data[i]['materialId']+">X</span><input type='checkbox' checked name='materialId' class='' value='"+data[i]['materialId']+"' id='materialId'><label for='materialId' class='btn_selected right-8px'><img src='./image/client_background/white_gou.png'></label></div>");
						}else{
							$('.videoList').append("<div class='videoItem' onclick='isSelected(this)'><video controls src='"+data[i]['materialBody']+"' width='238px' height='125px'></video><span class='del_icon2 hidden' onclick='delItem(this)' data-option="+data[i]['materialId']+">X</span><input type='checkbox' name='materialId' class='' value='"+data[i]['materialId']+"' id='materialId'><label for='materialId' class='btn_selected right-8px hidden'><img src='./image/client_background/white_gou.png'></label></div>");
						}					
						$('.videoItem').mouseover(function(){
							$(this).children('.del_icon2').removeClass('hidden');
						});
						$('.videoItem').mouseout(function(){
							$(this).children('.del_icon2').addClass('hidden');
						});
					}	
					if(materialType==3){
						if(data[i]['isSelect']=='1'){
							$('.senceList').append("<div class='senceItem' onclick='isSelected(this)'><span class='del_icon2 hidden' onclick='delItem(this)' data-option="+data[i]['materialId']+">X</span><img src='"+data[i]['materialBody']+"' width='238px' height='125px'><input type='checkbox' checked name='materialId' class='' value='"+data[i]['materialId']+"' id='materialId'><label for='materialId' class='btn_selected right-8px'><img src='./image/client_background/white_gou.png'></label></div>");
						}else{
							$('.senceList').append("<div class='senceItem' onclick='isSelected(this)'><span class='del_icon2 hidden' onclick='delItem(this)' data-option="+data[i]['materialId']+">X</span><img src='"+data[i]['materialBody']+"' width='238px' height='125px'><input type='checkbox' name='materialId' value='"+data[i]['materialId']+"' class=''  id='materialId'><label for='materialId' class='btn_selected right-8px hidden'><img src='./image/client_background/white_gou.png'></label></div>");
						}
						$('.senceItem').mouseover(function(){
							$(this).children('.del_icon2').removeClass('hidden');
						});
						$('.senceItem').mouseout(function(){
							$(this).children('.del_icon2').addClass('hidden');
						});
					}
				}
			}
		});
	}

	// 选择素材
	function isSelected(obj){
		$(obj).children('input[type=checkbox]').click();
		if($(obj).children('input[type=checkbox]').is(':checked')){
			$(obj).children('label').removeClass('hidden');
		}else $(obj).children('label').addClass('hidden');
		// console.log($(obj).children('input').prop('checked'));
	}

	// 在素材对话框点击确认按钮
	function okMaterial(materialType){
		var str = "";
		var chksArr;
		if(materialType==2){
		    chksArr = $('#videoListForm').serialize().split('&');
		}
		if(materialType==3){
			chksArr = $('#senceListForm').serialize().split('&');
		}
		for(var i = 0;i<chksArr.length;i++){
			var idArr = chksArr[i].split('=');	
			str += idArr[1]+",";
		}
		// console.log(str);	
		$.ajax({
			url:"/machine_ad_material/"+adId,
			method:"post",
			data:{
				'materialType':materialType,
				'materialIds':str,
			},
			success:function(result){
				alert("成功更换展示内容！");
				$('.btn_cancel').click();
				window.location.reload();
			}
		});
	}

	// 触发上传
	function clickUpload(){
		$('#uploadSubmit').click();
	}

	// 上传素材(图片)
	function loadFile(materialType){
 		var form = $('form[name=imageForm]');
 		var options  = {    
            // url:'/materials?materialType='+materialType+'&adTemplate='+adTemplate+'&position=1',    
            url:'/materials',
            type:'post',    
            data:{
            	'materialType':materialType,
            	'adTemplate':adTemplate,
            	'position':1,
            },
            beforeSubmit:function(){
            	
            },
            success:function(result){   
               // console.log(result);
               var data = result['data'];
               	$('.senceList').append("<div class='senceItem' onclick='isSelected(this)'><span class='del_icon2 hidden' onclick='delItem(this)' data-option="+data[0]['materialId']+">X</span><img src='"+data[0]['materialBody']+"' width='238px' height='125px'><input type='checkbox' name='materialId' value='"+data[0]['materialId']+"' class=''  id='materialId'><label for='materialId' class='btn_selected right-8px hidden'><img src='./image/client_background/white_gou.png'></label></div>");
               	$('.senceItem').mouseover(function(){
					$(this).children('.del_icon2').removeClass('hidden');
				});
				$('.senceItem').mouseout(function(){
					$(this).children('.del_icon2').addClass('hidden');
				});
            },    
        };    
        form.ajaxSubmit(options);  
	}


	// 删除素材
	function delItem(obj){
		var materialId = $(obj).attr('data-option');
		// console.log(materialId);
		$.ajax({
			url:'/material/'+materialId,
			method:"delete",
			success:function(){
				var parent = $(obj).parent();
				$(parent).remove();
			}
		});	
	}

	// 添加显示内容（弹框加载数据）
	function loadProductData(){
		proCondition();
		proList2(1);
		// moreGoods2();
	}

	function proCondition(){
		$.ajax({
			url:"/dictionary",
			method:"get",
			success:function(result){
				// console.log(result);
				var data = result['data'];
				for(var i = 0;i<data['types'].length;i++){
					$('#types').append("<option value='"+data['types'][i]+"'>"+data['types'][i]+"</option>");
				}
				for(var i = 0;i<data['brands'].length;i++){
					$('#brands').append("<option value='"+data['brands'][i]+"'>"+data['brands'][i]+"</option>");
				}
				for(var i = 0;i<data['spaces'].length;i++){
					$('#spaces').append("<option value='"+data['spaces'][i]+"'>"+data['spaces'][i]+"</option>");
				}
				for(var i = 0;i<data['pmade'].length;i++){
					$('#pmade').append("<option value='"+data['pmade'][i]+"'>"+data['pmade'][i]+"</option>");
				}
				for(var i = 0;i<data['styles'].length;i++){
					$('#styles').append("<option value='"+data['styles'][i]+"'>"+data['styles'][i]+"</option>");
				}
			}
		});		
	}
	
	// 弹出框时加载列表数据
	function proList2(pageNum2){
		$('#productList2 tbody').html("");
		var price = $('#price').val();
		var type = $('#types').val();
		var brand = $('#brands').val();
		var space = $('#spaces').val();
		var pmade = $('#pmade').val();
		var style = $('#styles').val();
		var keyword = $('#keyword').val();

		var range1 = $('input[name=range1]').val();
		var range2 = $('input[name=range2]').val();
		if(range1!=""&&range2!=""){
			price = range1 + "-" +range2;
		}else price = $('#price').val();
		// console.log(price+","+type+","+brand+","+space+","+pmade+","+style);
		// console.log("当前页码："+pageNum2);
		$.ajax({
			url:"/products/"+adId,
			method:"get",
			data:{
				'pageNumber':pageNum2,
				'pageSize':10,
				'price':price,
				'ptype':type,
				'brand':brand,
				'aspace':space,
				'pmade':pmade,
				'pstyle':style,
				'keyword':keyword,
			},
			success:function(result){
				// console.log(result);
				var data = result['data'];
				for(var i = 0;i<data['list'].length;i++){
					var item = data['list'][i];
					$('#productList2 tbody').append("<tr onclick='rowClick(this)'><td width='100px'>"+item['productnum']+"</td><td width='72px'><img width='70px' heigth='60px' src='"+item['imgpath']+"'></td><td width='180px'>"+item['productname']+"</td><td width='80px'>"+item['brand']+"</td><td width='70px'>￥"+item['mallsaleprice']+"</td><td width='25px'><input type='checkbox' name='pro_chks' value='"+item['productid']+"'></td></tr>");
				}
				$('#totalCount').html(data['totalRecords']).css('color','red');
				totalPages = data['totalPages'];
			}
		});
	}

	// 上下页
	function pre_next(num){
		pageNum2 = pageNum2 + num;
		if(pageNum2>=totalPages){
			pageNum2 = totalPages;
			alert("没有下一页了！");
		}
		if(pageNum2<=1){
			pageNum2 = 1;
			alert("没有上一页了！");
		}
		$('#productList2 tbody').html("");
		proList2(pageNum2);
	}	

	//  点击某一行就选中
	function rowClick(obj){
		$(obj).children().children('input[type=checkbox]').click();
	}
	// 获取选中的产品id
	function pro_getSelect(){
		if($('#selAllPro').is(':checked')){
			var price = $('#price').val();
			var ptype = $('#types').val();
			var brand = $('#brands').val();
			var aspace = $('#spaces').val();
			var pmade = $('#pmade').val();
			var pstyle = $('#styles').val();
			var keyword = $('#keyword').val();
			var range1 = $('input[name=range1]').val();
			var range2 = $('input[name=range2]').val();
			if(range1!=""&&range2!=""){
				price = range1 + "-" +range2;
			}else price = $('#price').val();

			var condition = 'price='+price+'&ptype='+ptype+'&brand='+brand+'&aspace='+aspace+'&pmade='+pmade+'&pstyle='+pstyle+'&keyword='+keyword;
			console.log(condition);
			var data = JSON.stringify("{'materialType':4,'adTemplate':"+adTemplate+",'position':1,'condition':{'price':"+price+",'ptype':"+ptype+",'brand':"+brand+",'aspace':"+aspace+",'pmade':"+pmade+",'pstyle':"+pstyle+",'keyword':"+keyword+"}");
			$.ajax({
				url:"/machine_ad_product/"+adId,
				method:"post",
				contentType: "application/json",
            	dataType: "json",
				data:
				JSON.stringify({'materialType':4,'adTemplate':adTemplate,
					'position':1,
					// 'condition':condition,
					'condition':{
						'price':price,
						'ptype':ptype,
						'brand':brand,
						'aspace':aspace,
						'pmade':pmade,
						'pstyle':pstyle,
						'keyword':keyword
					}
				}),
				success:function(){
					console.log('全选成功！');
					$('.btn_cancel').click();
				}
			});
		}else{
			var str = "";
			var chksArr = $('#proForm').serialize().split('&');
			for(var i = 0;i<chksArr.length;i++){
				var idArr = chksArr[i].split('=');	
				str += idArr[1]+",";
			}
			$.ajax({
				url:"/machine_ad_product/"+adId,
				method:"post",
				data:{
					'materialType':1,
					'adTemplate':adTemplate,
					'position':1,
					'addProducts':str,
				},
				success:function(){
					alert("添加成功！");
					$('.btn_cancel').click();
				}
			});
		}	
	}


	// 上传视频
	var host;
	var uploadToken;
	$(function(){
		qiniuUpload();
	});
	function qiniuUpload(){	
		$.ajax({
			url:"/uploadtoken",
			method:"get",
			success:function(result){
				// console.log(result);
				host = result['data']['host'];
				uploadToken = result['data']['uploadToken'];
				// console.log(host+","+uploadToken);
				var uploader = Qiniu.uploader({
				    runtimes: 'html5,flash,html4',      // 上传模式，依次退化
				    browse_button: 'uploadVideo',         // 上传选择的点选按钮，必需
				    // 在初始化时，uptoken，uptoken_url，uptoken_func三个参数中必须有一个被设置
				    // 切如果提供了多个，其优先级为uptoken > uptoken_url > uptoken_func
				    // 其中uptoken是直接提供上传凭证，uptoken_url是提供了获取上传凭证的地址，如果需要定制获取uptoken的过程则可以设置uptoken_func
				     uptoken :uploadToken , // uptoken是上传凭证，由其他程序生成
				     uptoken_url: '/uptoken',         // Ajax请求uptoken的Url，强烈建议设置（服务端提供）
				     uptoken_func: function(file){    // 在需要获取uptoken时，该方法会被调用
				        // do something
				        return uptoken;
				     },
				    get_new_uptoken: false,             // 设置上传文件的时候是否每次都重新获取新的uptoken
				    // downtoken_url: '/downtoken',
				    // Ajax请求downToken的Url，私有空间时使用，JS-SDK将向该地址POST文件的key和domain，服务端返回的JSON必须包含url字段，url值为该文件的下载地址
				    // unique_names: true,              // 默认false，key为文件名。若开启该选项，JS-SDK会为每个文件自动生成key（文件名）
				    // save_key: true,                  // 默认false。若在服务端生成uptoken的上传策略中指定了sava_key，则开启，SDK在前端将不对key进行任何处理
				    domain: host,     // bucket域名，下载资源时用到，必需
				    container: 'container',             // 上传区域DOM ID，默认是browser_button的父元素
				    max_file_size: '100mb',             // 最大文件体积限制
				    flash_swf_url: 'path/of/plupload/Moxie.swf',  //引入flash，相对路径
				    max_retries: 3,                     // 上传失败最大重试次数
				    dragdrop: true,                     // 开启可拖曳上传
				    drop_element: 'container',          // 拖曳上传区域元素的ID，拖曳文件或文件夹后可触发上传
				    chunk_size: '4mb',                  // 分块上传时，每块的体积
				    auto_start: true,                   // 选择文件后自动上传，若关闭需要自己绑定事件触发上传
				    
				    init: {
				        'FilesAdded': function(up, files) {
				            plupload.each(files, function(file) {
				                // 文件添加进队列后，处理相关的事情
				                console.log("文件添加进队列");
				                $('.uploadProgress').removeClass('hidden');
				            });
				        },
				        'BeforeUpload': function(up, file) {
				               // 每个文件上传前，处理相关的事情
				                console.log("文件准备上传");
				                $('.uploadProgress').removeClass('hidden');
				        },
				        'UploadProgress': function(up, file) {
				                console.log("文件正在上传");
				                $('.uploadProgress').removeClass('hidden');

				                
				        },
				        'FileUploaded': function(up, file, info) {
				        	 console.log("文件上传成功");
				        	  $('.uploadProgress').addClass('hidden');
				        	 // 每个文件上传成功后，处理相关的事情
				               // 其中info是文件上传成功后，服务端返回的json，形式如：
				               // {
				               //    "hash": "Fh8xVqod2MQ1mocfI4S4KpRL6D98",
				               //    "key": "gogopher.jpg"
				               //  }
				               // 查看简单反馈
				               var domain = up.getOption('domain');
				               var res = JSON.parse(info);
				               var sourceLink = domain + res.key;  // 获取上传成功后的文件的Url
				              var myDate = new Date();
							  var now = myDate.getFullYear();       
								now += myDate.getMonth();       
								now += myDate.getDate();              
								now += myDate.getTime();        
								now += myDate.getHours();       
								now += myDate.getMinutes();     
								now += myDate.getSeconds();    
								now = now + ".mp4";
				               console.log(now);
				        	 $.ajax({
				        	 	url:"/materials",
				        	 	method:"post",
				        	 	data:{
				        	 		materialType:2,
				        	 		adTemplate:adTemplate,
				        	 		position:1,
				        	 		materialTitle:now, 
				        	 		materialBody:sourceLink,
				        	 	},
				        	 	success:function(result){
				        	 		console.log(result);
				        	 		var data = result['data'];
				        	 		$('.videoList').append("<div class='videoItem' onclick='isSelected(this)'><video controls src='"+data[0]['materialBody']+"' width='238px' height='125px'></video><span class='del_icon2 hidden' onclick='delItem(this)' data-option="+data[0]['materialId']+">X</span><input type='checkbox' name='materialId' class='' value='"+data[0]['materialId']+"' id='materialId'><label for='materialId' class='btn_selected right-8px hidden'><img src='./image/client_background/white_gou.png'></label></div>");
				        	 		$('.videoItem').mouseover(function(){
										$(this).children('.del_icon2').removeClass('hidden');
									});
									$('.videoItem').mouseout(function(){
										$(this).children('.del_icon2').addClass('hidden');
									});
				        	 	}
				        	 });       
				        },
				        'Error': function(up, err, errTip) {
				               //上传出错时，处理相关的事情
				                alert("文件上传出错");
				                 $('.uploadProgress').addClass('hidden');
				        },
				        'UploadComplete': function() {
				               //队列文件处理完毕后，处理相关的事情
				                console.log("全部上传成功，队列为空");
				        },
				        'Key': function(up, file) {
				            // 若想在前端对每个文件的key进行个性化处理，可以配置该函数
				            // 该配置必须要在unique_names: false，save_key: false时才生效
				
				            var key = "";
				            // do something with key here
				            return key
				        }
				    }
				});//upload结束
			}
		});
	}

	
</script>