<div class="top">
	<h2>以下是该机器的【屏保设置】</h2>
</div>
<div class="content_box">
	<div class="info_box">
		<p>滚屏公告：<input type="text" name="notice" placeholder="请输入滚屏公告">&nbsp;&nbsp;显示公告：<input type="checkbox" name="showNotice" id="showNotice"></p>
		<p>
			屏保模板：
			<select name="adTemplate" id="adTemplate" style="width:150px">
				<option  value="1">产品为主的模板</option>
				<option  value="2">视频为主的模板</option>
				<option  value="3">海报为主的模板</option>
				<option  value="4">天气为主的模板</option>
			</select>
			&nbsp;<a href="/adv_template_poster.psd">850x505px PSD海报模板下载</a>&nbsp;
			&nbsp;<a href="/adv_template_other.psd">720x325px PSD海报模板下载</a>
		</p>
		<button class="btn_save" onclick="ad_save()">保存设置</button>
	</div>

	<!-- 展示部分 -->
	<div class="showBox">
		<div class="showContent">
			<div class="left_box">
				<div class="leftImg">
					<img src="./image/client_background/shenqi_tigan.png">
					<img src="./image/client_background/shenqi_camera.png">
				</div>
				<div class="listBox">
				<div class="mask">
					<div class="productList"></div>
				</div>
				<div class="topBar hidden">
					<p>
						<input type="text" name="keyWord" placeholder="输入产品关键字">
						<a class="search_btn" onclick="productList(1)"><img src="./image/client_background/search_btn.png" heigth="26px"></a>
						<a class="del_btn"><img src="./image/client_background/material_delete.png" height="25px"></a>
						<a class="addShow_btn" data-toggle="modal" data-target="#lampModal" onclick="loadProductData()">添加展示内容</a>
					</p>
				</div>
				</div>
			</div>

			<div class="right_box">
				<div class="video">
					<video controls src=""></video>
					<div class="topBar hidden">
						<a href="#" class="changeVideo btn_change" data-toggle="modal" data-target="#videoModal" onclick="loadMaterial(2)">更换展示内容</a>
					</div>
				</div>
				<div class="sence">
					<!-- 轮播 -->
					<div id="carousel-example-generic" class="carousel slide" data-ride="carousel" >
						   <div class="carousel-inner" role="listbox"></div>
						  <a class="left carousel-control" href="#carousel-example-generic" role="button" data-slide="prev"></a>
						  <a class="right carousel-control" href="#carousel-example-generic" role="button" data-slide="next"></a>
					</div>
					<div class="topBar hidden">
						<a href="#" class="changePic btn_change" data-toggle="modal" data-target="#senceModal" onclick="loadMaterial(3)">更换展示内容</a>
					</div>
				</div>
			</div>
		</div>
	</div>
</div> 



<script type="text/javascript">

	var machineId = getUrlParam('machineId');
	var adId;
	var adTemplate;  //模板类型(以产品为主，视频为主，海报为主，天气为主)
	var pageNum = 1;   //页面中的页码
	var pageNum2 =1;   //弹出框里面的页码

	window.onload=loadData();

	// 页面初始加载数据
	function loadData(){
		overOut(".listBox",".listBox .topBar");		
		overOut(".video",".video .topBar");
		overOut(".sence",".sence .topBar");

		$.ajax({
			url:"/machine_ad/"+machineId,
			method:"get",
			success:function(result){
				var data = result['data'];
				// info
				adId = data['ad']['adId'];
				adTemplate = data['ad']['adTemplate'];
				$('input[name=notice]').val(data['ad']['notice']);
				if(data['ad']['showNotice']==0){
					document.getElementById('showNotice').checked = false;
				}else document.getElementById('showNotice').checked = true;
				$('#adTemplate').val(data['ad']['adTemplate']);
				// showBox
				for(var i = 0 ;i<data['materials'].length;i++){
					if(data['materials'][i]['materialType']==2){
						$('.video video').attr('src',data['materials'][i]['materialBody']);
					}
					if(data['materials'][i]['materialType']==3){
						$('.sence .carousel-inner').append("<div class='item' style='background:#fff;'><img src='"+data['materials'][i]['materialBody']+"'></div>");
						$('.carousel-inner .item').eq(1).addClass('active');
					}					
				}	
			},
		});
		productList(1);
		moreGoods();
	}	

	// 保存屏保设置
	function ad_save(){
		var notice = $('input[name=notice]').val();
		var adTemplate = $('#adTemplate').val();
		// var showNotice = document.getElementById('showNotice').value;
		var showNotice = $('#showNotice').eq(0).val();
		if(showNotice=="on"){
			showNotice = 1
		}else showNotice = 0;
		console.log(notice+","+adTemplate+","+showNotice);
		$.ajax({
			url:"/machine_ad/"+adId,
			method:"post",
			data:{
				adTemplate:adTemplate,
				showNotice:showNotice,
				notice:notice,
			},
			success:function(){
				alert("修改成功！");
			}
		});
	}

	// 加载产品列表
	function productList(pageNum){
		var proKey = $('input[name=keyWord]').val();
		$.ajax({
			url:"/machine_ad_product/"+machineId+"/1",
			method:"get",
			data:{
				pageNumber:pageNum,
				pageSize:16,
				keyword:proKey
			},
			success:function(result){
				console.log(result);
				var data = result['data'];
				for(var i = 0;i<data['list'].length;i++){
					$('.productList').append("<div class='item'><img src='"+data['list'][i]['imgpath']+"'><p>"+data['list'][i]['productnum']+"</p><span class='del_icon' onclick='delOne(this)' data-mid='"+data['list'][i]['materialId']+"' data-pid='"+data['list'][i]['productid']+"'>X</span></div>");
				}
			}
		});
	}

	// 当鼠标滚动时加载更多产品
	function moreGoods(){  //flag=1：页面中的分页，flag= 2 ：弹框中的分页
		var nScrollHight = 0; //滚动距离总长(注意不是滚动条的长度)
	    var nScrollTop = 0;   //滚动到的当前位置
	    var nDivHight = $(".listBox").height();
		 $(".listBox").scroll(function(){
	          nScrollHight = $(this)[0].scrollHeight;
	          nScrollTop = $(this)[0].scrollTop;
	          if(nScrollTop + nDivHight >= nScrollHight)
		          	productList(pageNum);
	         	// console.log(pageNum);
	         	pageNum += 1;    	
         });
	}
	

	// 页面中删除单个产品
	function delOne(obj){
		var materialId = $(obj).attr('data-mid');
		var productId = $(obj).attr('data-pid');
		console.log(materialId+","+productId);
		$.ajax({
			url:"/remove_product/"+materialId,
			method:"post",
			data:{
				productId:productId
			},
			success:function(){
				var parent = $(obj).parent();
				$(parent).remove();
				console.log("del");
			}
		});
	}

	
</script>

<!-- lampModal -->		
<div class="modal fade" id="lampModal" tabindex="-1" role="dialog" aria-labelledby="lampModalLabel">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">X</span>
				</button>
				<h4 class="modal-title" id="lampModalLabel">显示产品条件筛选</h4>
				
			</div>
			<div class="modal-body">
				<div class="proCondition">
					<p>
						风格：<select name="styles" id="styles" onchange="proList2()"><option value="">全部</option></select>&nbsp;&nbsp;
						类型：<select name="types" id="types" onchange="proList2()"><option value="">全部</option></select>
					</p>
					<p>
						空间：<select name="spaces" id="spaces" onchange="proList2()"><option value="">全部</option></select>&nbsp;&nbsp;
						材质：<select name="pmade" id="pmade" onchange="proList2()"><option value="">全部</option></select>
					</p>
					<p>
						价格：<select name="price" id="price" onchange="proList2()">
								  <option value="">全部</option>
								  <option value="0-499">0-499</option>
								  <option value="500-1999">500-1999</option>
								  <option value="2000-4999">2000-4999</option>
								  <option value="5000-9999">5000-9999</option>
								  <option value="10000-19999">10000-19999</option>
								  <option value="20000以上">20000以上</option>
							  </select>&nbsp;&nbsp;
						自定义价格段:<input type="text" name="range1">--<input type="text" name="range2">
					</p>
					<p>
						品牌：<select name="brands" id="brands" onchange="proList2()"><option value="">全部</option></select>&nbsp;&nbsp;
						关键字：<input type="text" name="keyword" id="keyword"> <button class="btn_search" onclick="proList2()">查询</button>
					</p>
				</div>
				
				<table class="" title="Basic DataGrid" style="width:550px;height:250px" id="easyuiList" data-options="singleSelect:true,collapsible:true,url:'../jquery-easyui-1.5/demo/datagrid/datagrid_data1.json',method:'get'"
					rownumbers="true" pagination="true">
					
					<!-- <thead> -->
						<tr>
							<th data-options="field:'itemid',width:80">Item ID</th>
							<th data-options="field:'productid',width:100">Product</th>
							<th data-options="field:'listprice',width:80,align:'right'">List Price</th>
							<th data-options="field:'unitcost',width:80,align:'right'">Unit Cost</th>
							<th data-options="field:'attr1',width:200">Attribute</th>
							<th data-options="field:'status',width:60,align:'center'">Status</th>
							<th field="ck" checkbox="true"></th>
						</tr>
					<!-- </thead> -->
				</table>
				
			</div>
			<div class="modal-footer">
				<p>=====符合条件的商品共<span id="totalCount"></span>个=====<input type="checkbox" name="">选择当前条件下的所有商品</p>
				<button type="button" class="btn_ok">确定</button>
				<button type="button" class="btn_cancel" data-dismiss="modal">取消</button>
			</div>
		</div>
	</div>
</div>



<script>
	function loadProductData(){
		proCondition();
		$('#easyuiList').dataGrid({

		});
	}
</script>
<!-- videoModal -->		
<div class="modal fade" id="videoModal" tabindex="-1" role="dialog" aria-labelledby="videoModalLabel">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">X</span>
				</button>
				<h4 class="modal-title" id="videoModalLabel">素材选择</h4>
				
			</div>
			<form id="videoListForm"><div class="modal-body videoList"></div></form>
			<div class="modal-footer">
				<input type="file" class="hidden" id="uploadVideo" onchange="loadFile(2)">
				<label for="uploadVideo" class="btn_ok">上传素材</label>
				<button type="button" class="btn_ok" onclick="okMaterial(2)">确定</button>
				<button type="button" class="btn_cancel" data-dismiss="modal">取消</button>
				<p class="upload_tips">上传视频最大为600Mb，建议分辨率不低于560p。</p>
			</div>
		</div>
	</div>
</div>
<!-- senceModal -->		
<div class="modal fade" id="senceModal" tabindex="-1" role="dialog" aria-labelledby="senceModalLabel">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">X</span>
				</button>
				<h4 class="modal-title" id="senceModalLabel">素材选择</h4>
				
			</div>
			<form id="senceListForm"><div class="modal-body senceList"></div></form>
			<div class="modal-footer">
				<!-- 上传图片 -->
				<form method="post" action="/materials" id="imageForm" name="imageForm" enctype="multipart/form-data" style="display:inline-block;">	
					<input type="file" class="hidden" name="uploadImage" id="uploadImage" onchange="clickUpload()">
					<label for="uploadImage" class="btn_ok">上传素材</label>
					<!-- <input type="hidden" name="materialType" value="3">
					<input type="hidden" name="adTemplate" value="1">
					<input type="hidden" name="position" value="3"> -->
					<input type="button" name="" class="hidden" id="uploadSubmit" onclick="loadFile(3)">
				</form>
				<button type="button" class="btn_ok" onclick="okMaterial(3)">确定</button>
				<button type="button" class="btn_cancel" data-dismiss="modal">取消</button>
				<p class="upload_tips">上传海报尺寸建议为720px*325px，最多一次上传6个。</p>
			</div>
		</div>
	</div>
</div>


<script type="text/javascript">
  
  // 更换展示内容(弹框加载数据)
	function loadMaterial(materialType){
		$.ajax({
			url:"/materials",
			method:"get",
			data:{
				materialType:materialType
				// adTemplate:"",
				// position:"",
			},
			success:function(result){
				var data = result['data'];
				$('.videoList').html("");
				$('.senceList').html("");
				console.log("素材列表："+result);
				for(var i = 0;i<data.length;i++){
					if(materialType==2){
						if(data[i]['isSelect']=='1'){
							$('.videoList').append("<div class='videoItem' onclick='isSelected(this)'><span class='del_icon2 hidden'>X</span><video controls src='"+data[i]['materialBody']+"' width='240px' height='125px'></video><input type='checkbox' checked='true' name='materialId' value='"+data[i]['materialId']+"' class='' id='select_video"+i+"'><label for='select_video"+i+"' class='btn_selected right-8px'><img src='./image/client_background/white_gou.png'></label></div>");	
						}else{
							$('.videoList').append("<div class='videoItem' onclick='isSelected(this)'><span class='del_icon2 hidden'>X</span><video controls src='"+data[i]['materialBody']+"' width='240px' height='125px'></video><input type='checkbox' name='materialId' value='"+data[i]['materialId']+"' class='' id='select_video"+i+"'><label for='select_video"+i+"' class='btn_selected right-8px hidden'><img src='./image/client_background/white_gou.png'></label></div>");	
						}					
						$('.videoItem').mouseover(function(){
							$(this).children('.del_icon2').removeClass('hidden');
						});
						$('.videoItem').mouseout(function(){
							$(this).children('.del_icon2').addClass('hidden');
						});
					}	
					if(materialType==3){
						if(data[i]['isSelect']=='1'){
							$('.senceList').append("<div class='senceItem' onclick='isSelected(this)'><span class='del_icon2 hidden' onclick='delItem(this)' data-option="+data[i]['materialId']+">X</span><img src='"+data[i]['materialBody']+"' width='238px' height='125px'><input type='checkbox' checked name='materialId' class='' value='"+data[i]['materialId']+"' id='materialId'><label for='materialId' class='btn_selected right-8px'><img src='./image/client_background/white_gou.png'></label></div>");
						}else{
							$('.senceList').append("<div class='senceItem' onclick='isSelected(this)'><span class='del_icon2 hidden' onclick='delItem(this)' data-option="+data[i]['materialId']+">X</span><img src='"+data[i]['materialBody']+"' width='238px' height='125px'><input type='checkbox' name='materialId' value='"+data[i]['materialId']+"' class=''  id='materialId'><label for='materialId' class='btn_selected right-8px hidden'><img src='./image/client_background/white_gou.png'></label></div>");
						}
						$('.senceItem').mouseover(function(){
							$(this).children('.del_icon2').removeClass('hidden');
						});
						$('.senceItem').mouseout(function(){
							$(this).children('.del_icon2').addClass('hidden');
						});
					}
				}
			}
		});
	}

	// 选择素材
	function isSelected(obj){
		$(obj).children('input[type=checkbox]').click();
		if($(obj).children('input[type=checkbox]').is(':checked')){
			$(obj).children('label').removeClass('hidden');
		}else $(obj).children('label').addClass('hidden');
		console.log($(obj).children('input').prop('checked'));
	}

	// 在素材对话框点击确认按钮
	function okMaterial(materialType){
		var str = "";
		var chksArr;
		if(materialType==2){
		    chksArr = $('#videoListForm').serialize().split('&');
		}
		if(materialType==3){
			chksArr = $('#senceListForm').serialize().split('&');
		}
		for(var i = 0;i<chksArr.length;i++){
			var idArr = chksArr[i].split('=');	
			str += idArr[1]+",";
		}
		console.log(str);	
		$.ajax({
			url:"/machine_ad_material/"+adId,
			method:"post",
			data:{
				'materialType':materialType,
				'materialIds':str,
			},
			success:function(result){
				alert("成功更换展示内容！");
				$('.btn_cancel').click();
				console.log(result);
			}
		});
	}

	// 触发上传
	function clickUpload(){
		$('#uploadSubmit').click();
	}

	// 上传素材
	function loadFile(materialType){
 		var form = $('form[name=imageForm]');
 		var options  = {    
            // url:'/materials?materialType='+materialType+'&adTemplate='+adTemplate+'&position=1',    
            url:'/materials',
            type:'post',    
            data:{
            	'materialType':materialType,
            	'adTemplate':adTemplate,
            	'position':1,
            },
            beforeSubmit:function(){
            	
            },
            success:function(result){   
               console.log(result);
               var data = result['data'];
               	$('.senceList').append("<div class='senceItem' onclick='isSelected(this)'><span class='del_icon2 hidden'>X</span><img src='"+data[0]['materialBody']+"' width='238px' height='125px'><input type='checkbox' name='materialId' value='"+data[0]['materialId']+"' class=''  id='materialId'><label for='materialId' class='btn_selected right-8px hidden'><img src='./image/client_background/white_gou.png'></label></div>");
            },    
        };    
        form.ajaxSubmit(options);  
	}

	// 删除素材
	function delItem(obj){
		var materialId = $(obj).attr('data-option');
		console.log(materialId);
		$.ajax({
			url:'/material/'+materialId,
			method:"delete",
			success:function(){
				var parent = $(obj).parent();
				$(parent).remove();
				console.log('gg');
			}
		});	
	}

	// 添加显示内容（弹框加载数据）
	// function loadProductData(){
	// 	proCondition();
	// 	proList2(1);
	// 	// moreGoods2();
	// }

	function proCondition(){
		$.ajax({
			url:"/dictionary",
			method:"get",
			success:function(result){
				console.log(result);
				var data = result['data'];
				for(var i = 0;i<data['types'].length;i++){
					$('#types').append("<option value='"+data['types'][i]+"'>"+data['types'][i]+"</option>");
				}
				for(var i = 0;i<data['brands'].length;i++){
					$('#brands').append("<option value='"+data['brands'][i]+"'>"+data['brands'][i]+"</option>");
				}
				for(var i = 0;i<data['spaces'].length;i++){
					$('#spaces').append("<option value='"+data['spaces'][i]+"'>"+data['spaces'][i]+"</option>");
				}
				for(var i = 0;i<data['pmade'].length;i++){
					$('#pmade').append("<option value='"+data['pmade'][i]+"'>"+data['pmade'][i]+"</option>");
				}
				for(var i = 0;i<data['styles'].length;i++){
					$('#styles').append("<option value='"+data['styles'][i]+"'>"+data['styles'][i]+"</option>");
				}
			}
		});		
	}
	
	// 弹出框时加载列表数据
	function proList2(pageNum2){
		$('#productList2 tbody').html("");
		var price = $('#price').val();
		var type = $('#types').val();
		var brand = $('#brands').val();
		var space = $('#spaces').val();
		var pmade = $('#pmade').val();
		var style = $('#styles').val();
		var keyword = $('#keyword').val();

		var range1 = $('input[name=range1]').val();
		var range2 = $('input[name=range2]').val();
		if(range1!=""&&range2!=""){
			price = range1 + "-" +range2;
		}else price = $('#price').val();
		console.log(price+","+type+","+brand+","+space+","+pmade+","+style);
		$.ajax({
			url:"/products/"+adId,
			method:"get",
			data:{
				'pageNumber':pageNum2,
				'pageSize':7,
				'price':price,
				'ptype':type,
				'brand':brand,
				'aspace':space,
				'pmade':pmade,
				'pstyle':style,
				'keyword':keyword,
			},
			success:function(result){
				console.log(result);
				var data = result['data'];
				for(var i = 0;i<data['list'].length;i++){
					var item = data['list'][i];
					$('#productList2 tbody').append("<tr><td>"+item['productnum']+"</td><td><img width='70px' heigth='60px' src='"+item['imgpath']+"'></td><td>"+item['productname']+"</td><td>"+item['brand']+"</td><td>￥"+item['mallsaleprice']+"</td><td><input type='checkbox'></td></tr>");
				}
				$('#totalCount').html(data['totalRecords']).css('color','red');
				moreGoods2();
			}
		});
	}

	// 当鼠标滚动时加载更多产品
	function moreGoods2(){
		var nScrollHight = 0; //滚动距离总长(注意不是滚动条的长度)
	    var nScrollTop = 0;   //滚动到的当前位置
	    var nDivHight = $('#productList2_box tbody').height();
	    console.log("box高度为："+nDivHight);
	    // console.log("box的tbody高度为："+$('#productList2 tbody').height());
		 $("#productList2_box").scroll(function(){
	          nScrollHight = $(this)[0].scrollHeight;
	          nScrollTop = $(this)[0].scrollTop;
	          console.log(nScrollHight+",top:"+nScrollTop);
	          if(nScrollTop + nDivHight >= nScrollHight){
	          		proList2(pageNum2);
          			pageNum2 += 1; 
	          }       		   	
	         	
         });
	}

	
</script>